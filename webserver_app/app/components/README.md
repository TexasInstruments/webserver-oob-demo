
# **GUI Composer v3: ti-guicomposer-components**

# Overview
## Directory Structure
* **src** : source code for the components.  Also contains an assets folder for icons and images.  The contents of the src folder are saved in the git repo
* **prebuild/src2** : the contents of this folder are generated by the mixin-tool.  This folder provides the source code that is compiled by the Stencil compiler, as configured by the stencil.config.ts file.
* **dist, www, @ti**: these folders are generated by the stencil compiler.  
   * **dist**: used by ticom for deployment of generated web components
   * **@ti**: contains TI web component folders, each of which includes the generated README.md for the component, the compiled .js files for the web component, and the test and demo folders that were created in the src folder for the web component.
 * **tools**: contains the analyzer.js file and any other misc. tools required for development

## Special Files
* **gulpfile.js**: contains gulp tasks that are used by variouis npm scripts
* **metadata.json**: generated by running **npm run metadata**, which runs tools/analyzer.js 
* **index.html**: the web page displayed when you run **npm start** (was previously src/index.html)
* **.npmrc**: resource file for npm that configures it to be able to access the ticom-ui-components git repo 
* **stencil.config.ts**: configuration file for the Stencil compiler. **NOTE: do not edit this file!**.  Instead, edit either of the following 2 files, which are copied to stencil.config.ts by the npm build scripts
   * **stencil.components.ts**: configures the Stencil compiler to generate individual web component folders in @ti
   * **stencil.bundle.ts**: configures the Stencil compiler to generate a components.js file containing all of the components and supporting lazy loading of the components

# Development Environment Setup

## git 
It is recommended that you start with a clean install of the ti-guicomposer-designer git repo on the GC3-dev branch. 
```
git clone ssh://git@bitbucket.itg.ti.com/gc/ti-guicomposer-designer.git GC3_dev
cd GC3_dev
git checkout -b GC3-dev
git fetch origin GC3-dev
git reset --hard origin/GC3-dev
npm install
```
See the [README.md](https://bitbucket.itg.ti.com/projects/GC/repos/ti-guicomposer-designer/browse/README.md?at=refs%2Fheads%2FGC3-dev) for details.

You then need to do the following, starting from the root directory of the new git repo:
- cd designer/v3/components
- git checkout -b GC3-stencil (or git checkout GC3-stencil if branch already exists)
- git fetch origin GC3-stencil
- git reset --hard origin/GC3-stencil

All of the following commands need to be run from the &lt;ti-guicomposer-designer git repo root&gt;/designer/v3/components folder.
If you switch to a different git branch for the components, it is recommended that you use the same git fetch origin GC3-stencil and git reset --hard origin/GC3-stencil commands to switch back to this branch.  This will clean out all of the node_modules folder and other files left over from the other branch.  Then do npm install as described below to install all of the dependencies again.

### Updating tools
You must be logged in to BitBucket before running the following command:
gulp updateTools

## Environment

This project has the following dependencies:
- **nodeJS.js** v12.16.1 or later
- **npm** v6.13.4 or later
- **gulp-cli** v2.20 or later

<span style="color:orange">**NOTE:** npm requires a git client to be installed in order to install from a git repo.</span><br/>
If you get an error saying ```  undefined ls-remote -h -t ssh://git@bitbucket.itg.ti.com/gc/mixin-tool.git```, please try again from the git bash shell.

To install the project dependencies, open up **gitbash** or terminal and
```
npm install
npm install -g gulp-cli
```
  
# Quick Start
## npm scripts

To build the components, run:
```
npm run build
```

This will run gulp and perform the following tasks:
* clean the output folders
* copy the stencil.components.ts file to stencil.config.ts 
* run the mixin-tool to inline extended base classes with the component .tsx files
* run the stencil.js compiler
* copy the output components to the ./@ti folder
* run tools/analyzer.js to generate metadata for the generated components 
---
To build in watch-mode, without serving any files, run
```
npm run build.watch
```
---
To build in watch-mode and serve the files in the @ti folder
* using the stencil compiler's server (faster)
* and you want to use **VSCode to debug**, run:
```
npm start
```
or
```
npm run start
```
---
To build in watch-mode and serve the files in the @ti folder 
* using live-server (slower)
* and you want to use **Chrome Dev Tools to debug**, run:
```
npm run start.ti
```
NOTE: Wait until the command outputs **Ready for changes** before trying to interact/debug the index.html and demo/index.html files.  (Can take a couple of minutes after running npm run start.ti)

---
To update the readme.md documents for each component, run:
```
npm run docs
```
---
To inline the base Props for all components, run:
```
npm run mix.all
```
---
To inline the base Props for just the .tsx file in a component dir, from the component dir run:
```
gulp mix1
```
---
To update the mixin-tool and sourcemap-tool in node_modules, from a bash shell (or DOS command prompt if it supports git) run:
```
gulp updateTools
```
---
# Working with Stencil
* Please see [StencilNotes](https://twiki.dal.design.ti.com/bin/view/TorontoSDO/Architects/StencilNotes)

## Extending Base Classes
* Please see the README.md for the [mixin-tool](https://bitbucket.itg.ti.com/projects/GC/repos/mixin-tool/browse)

## Working with ticom-ui-components widgets
* The ticom-ui-components git repo is available [here](https://bitbucket.itg.ti.com/projects/GUILIB/repos/ticom-ui-components/browse)
* Please see this [Polaris demo page](http://4com.itg.ti.com/ims/imsds/polaris/1.9.0/components/button.html) for examples of the various ticom widgets and their attributes.  In general, you do not have to do anything to use one of these components in your Stencil component's render function - they are installed in the node_modules/@ticom folder when you do npm install.  
* **theming** is mostly defined by vars and mixins from the central sass, e.g. [link](
https://bitbucket.itg.ti.com/projects/GUILIB/repos/ticom-feature-components/browse/src/components/product-status/product-status.scss?at=refs%2Fheads%2Fstencil-one#51)
* **stencil.config.ts** for ticom-ui-components is available [here](https://bitbucket.itg.ti.com/projects/GUILIB/repos/ticom-ui-components/browse/stencil.config.ts)
* Please see the [ticom confluence page](https://confluence.itg.ti.com/display/DCPWGUIPL/Stencil+Web+Components+Guidelines+-+DRAFT) for more details.

# Source-level Debugging in VSCode
StencilJS does not currently support sourcemaps, so the sourcemap-tool has been created to generate mixin-aware sourcemaps.
The following sections provide more info on how to use this capability.
## VSCode Extensions
Install the Debugger for Chrome extension for VSCode [link](https://marketplace.visualstudio.com/items?itemName=msjsdiag.debugger-for-chrome)

## VSCode launch.json 
Create a VSCode launch with the following settings: 
```
		{
			"type": "chrome",
			"request": "attach",
			"name": "Attach to Chrome",
			"port": 9222,
			"url": "http://localhost:3333/",
			"webRoot": "${workspaceFolder}/www"
		}
```

## Set Chrome properties
### Windows
Configure your Chrome application with the following settings (right-click on Chrome taskbar icon, right click on "Google Chrome", select properties, set target field to the following.  Adjust as necessary for your PC's chrome.exe file location ):
```
"C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" --disable-features=RendererCodeIntegrity --remote-debugging-port=9222
```
### Linux
Run your chrome application from the command line with the --remote-debugging-port=9222 argument.  e.g.
```
google-chrome --remote-debugging-port=9222
```

## npm run start
In the designer/v3/components folder, run **npm run start**.  This will build the components and create source maps for them whenever files in the src folder are changed.
The src/index.html file should be displayed in the Chrome browser started in the previous step.
**NOTE**: it is important that the browser has a tab that is displaying the URL for http://localhost:3333 before you launch the VSCode debug session, as VSCode uses this URL to find the correct tab in the browser to attach the debugger to.
Things to watch out for:
* If you have navigated away from the startup page, the URL will be different and VSCode will not find it and will timeout.  Always return to the startup page before launching the VSCode debug session.
* If you run npm start repeatedly without closing down the tabs it was previously using, the port number will increment (e.g. to 3334), which will again cause the debug launch to timeout

## Using Breakpoints

* You cannot set breakpoints in the render function of a web component's .tsx file, as the sourcemaps that are generated do not support this.  If you need to debug the render function, you can remove the .map file for the web component from the @ti/build folder and then debug the *.entry.js file for the web component in the @ti/build folder.

---
# Common gotchas

### Component names must have hyphen
So you can't have an element called "card" for example. Stencil requires a hyphen in the name to tell it's an element.

Make sure to use a "ti-" prefix for components so that we can easily identify them on pages.

### Slots need special style
You need to use `::slotted()` when styling elements that come into a slot.
ref: https://alligator.io/web-components/composing-slots-named-slots/#styling-slotted-content-with-slotted

A good example is the ti-card element.
If we use the ti-card like this:
```html
<ti-card>
    <a slot="title" href='#'>{name}</a>
    ...
</ti-card>
```

The the ti-card template looks like this:
```html
<div class='reco-box'>
    <h6><slot name="title" /></h6>
    ...
</div>
```

In order to style the `<a>` properly, the scss for ti-card needs to look something like this:
```css
h6 {
    ::slotted(a) {
        text-decoration: none;
        &:visited {
            color: inherit;
        }
    }
}
```
---
# **Testing** *(UNDER CONSTRUCTION!)* 

Please see [Debugging Tests In Stencil](https://dev.to/pr3tori4n/a-guide-on-debugging-tests-in-stencil-age) for help with configuring VSCode to debug stencil tests.

## Updating ChromeDriver to match your Chrome version for Testing
Create a new folder for the new chrome driver in selenium_drivers folder.
Change gc-core-assets/test/SeleniumDriver.ts version to have matching driver version number.

## npm scripts
To run the unit tests for the components, run:
```
npm test
```

To run the end to end tests, run:
```
npm run test.e2e
```

If you want to _watch_ either tests so that you can make updates and have the tests run automatically just add `--watch` parameter to the end of either command. eg:
```
npm test --watch
```
or
```
npm run test.e2e --watch
```

## Writing unit tests
A lot of the functionality will probably be tested using e2e tests, but you can refer to Stencil's example of unit tests: https://stenciljs.com/docs/unit-testing

Think of unit tests in terms of testing the JavaScript API of the component (not the rendering).

## Writing e2e testing
We're using Stencil's e2e testing API.
See notes from Stencil: https://stenciljs.com/docs/end-to-end-testing

## Screenshot tests 
under construction - see ticom-ui-components/README.md

## Running performance tests
under construction - see ticom-ui-components/README.md
